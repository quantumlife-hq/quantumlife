<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuantumLife - Digital Twin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { transform: translateX(-20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
        .animate-slideIn { animation: slideIn 0.3s ease-out; }
        .animate-pulse { animation: pulse 2s infinite; }
        .hover-lift:hover { transform: translateY(-2px); box-shadow: 0 10px 40px -10px rgba(0,0,0,0.2); }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: { 50: '#f5f3ff', 100: '#ede9fe', 200: '#ddd6fe', 300: '#c4b5fd', 400: '#a78bfa', 500: '#8b5cf6', 600: '#7c3aed', 700: '#6d28d9', 800: '#5b21b6', 900: '#4c1d95' },
                        secondary: { 50: '#fdf4ff', 100: '#fae8ff', 200: '#f5d0fe', 300: '#f0abfc', 400: '#e879f9', 500: '#d946ef', 600: '#c026d3', 700: '#a21caf', 800: '#86198f', 900: '#701a75' }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, createContext, useContext } = React;
        const API_BASE = '/api/v1';

        // Context for global state
        const AppContext = createContext();

        // API helper
        async function api(endpoint, options = {}) {
            const response = await fetch(API_BASE + endpoint, {
                headers: { 'Content-Type': 'application/json' },
                ...options
            });
            if (!response.ok) throw new Error(`API error: ${response.status}`);
            return response.json();
        }

        // WebSocket hook
        function useWebSocket() {
            const [connected, setConnected] = useState(false);
            const [lastMessage, setLastMessage] = useState(null);
            const wsRef = useRef(null);

            useEffect(() => {
                const connect = () => {
                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const ws = new WebSocket(`${protocol}//${window.location.host}/ws`);

                    ws.onopen = () => setConnected(true);
                    ws.onclose = () => {
                        setConnected(false);
                        setTimeout(connect, 3000);
                    };
                    ws.onmessage = (e) => setLastMessage(JSON.parse(e.data));
                    wsRef.current = ws;
                };
                connect();
                return () => wsRef.current?.close();
            }, []);

            return { connected, lastMessage };
        }

        // Icons component
        function Icon({ name, className = "w-5 h-5" }) {
            const icons = {
                dashboard: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>,
                inbox: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" /></svg>,
                hats: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
                recommendations: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>,
                chat: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>,
                spaces: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>,
                settings: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>,
                learning: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>,
                bell: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>,
                check: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>,
                close: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>,
                chevronRight: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" /></svg>,
                refresh: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>,
                send: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>,
            };
            return icons[name] || null;
        }

        // Sidebar component
        function Sidebar({ currentView, setCurrentView, identity, wsConnected }) {
            const navItems = [
                { id: 'dashboard', label: 'Dashboard', icon: 'dashboard' },
                { id: 'inbox', label: 'Inbox', icon: 'inbox' },
                { id: 'hats', label: 'Hats', icon: 'hats' },
                { id: 'recommendations', label: 'Recommendations', icon: 'recommendations' },
                { id: 'learning', label: 'Learning', icon: 'learning' },
                { id: 'chat', label: 'Agent Chat', icon: 'chat' },
                { id: 'spaces', label: 'Spaces', icon: 'spaces' },
                { id: 'settings', label: 'Settings', icon: 'settings' },
            ];

            return (
                <aside className="w-64 gradient-bg text-white flex flex-col min-h-screen">
                    <div className="p-6 border-b border-white/10">
                        <h1 className="text-2xl font-bold">QuantumLife</h1>
                        <p className="text-sm text-white/70 mt-1">Your Digital Twin</p>
                    </div>

                    <nav className="flex-1 p-4 space-y-1">
                        {navItems.map(item => (
                            <button
                                key={item.id}
                                onClick={() => setCurrentView(item.id)}
                                className={`w-full flex items-center px-4 py-3 rounded-lg transition-all ${
                                    currentView === item.id
                                        ? 'bg-white/20 text-white'
                                        : 'text-white/70 hover:bg-white/10 hover:text-white'
                                }`}
                            >
                                <Icon name={item.icon} className="w-5 h-5 mr-3" />
                                <span className="font-medium">{item.label}</span>
                            </button>
                        ))}
                    </nav>

                    <div className="p-4 border-t border-white/10">
                        <div className="flex items-center mb-3">
                            <div className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-lg">
                                {identity?.name?.[0] || '?'}
                            </div>
                            <div className="ml-3">
                                <div className="font-medium">{identity?.name || 'Loading...'}</div>
                                <div className="text-xs text-white/60">Digital Twin</div>
                            </div>
                        </div>
                        <div className="flex items-center text-xs text-white/60">
                            <span className={`w-2 h-2 rounded-full mr-2 ${wsConnected ? 'bg-green-400' : 'bg-gray-400'}`}></span>
                            {wsConnected ? 'Connected' : 'Reconnecting...'}
                        </div>
                    </div>
                </aside>
            );
        }

        // Stat Card component
        function StatCard({ label, value, color, icon, trend }) {
            return (
                <div className="bg-white rounded-xl p-6 shadow-sm hover-lift transition-all">
                    <div className="flex items-start justify-between">
                        <div>
                            <div className={`text-3xl font-bold ${color}`}>{value}</div>
                            <div className="text-gray-500 mt-1">{label}</div>
                        </div>
                        <div className={`w-12 h-12 rounded-lg ${color.replace('text-', 'bg-').replace('-600', '-100')} flex items-center justify-center`}>
                            <Icon name={icon} className={`w-6 h-6 ${color}`} />
                        </div>
                    </div>
                    {trend && (
                        <div className={`mt-3 text-sm ${trend > 0 ? 'text-green-600' : 'text-red-600'}`}>
                            {trend > 0 ? '‚Üë' : '‚Üì'} {Math.abs(trend)}% from last week
                        </div>
                    )}
                </div>
            );
        }

        // Activity Feed Item
        function ActivityItem({ activity }) {
            return (
                <div className="flex items-start p-4 hover:bg-gray-50 rounded-lg transition-colors animate-fadeIn">
                    <div className={`w-10 h-10 rounded-full flex items-center justify-center text-lg ${
                        activity.type === 'email' ? 'bg-blue-100' :
                        activity.type === 'calendar' ? 'bg-green-100' :
                        activity.type === 'task' ? 'bg-yellow-100' : 'bg-gray-100'
                    }`}>
                        {activity.type === 'email' ? 'üìß' : activity.type === 'calendar' ? 'üìÖ' : activity.type === 'task' ? '‚úì' : 'üìù'}
                    </div>
                    <div className="ml-4 flex-1">
                        <div className="font-medium text-gray-900">{activity.subject || activity.title}</div>
                        <div className="text-sm text-gray-500">{activity.from || activity.description}</div>
                        <div className="text-xs text-gray-400 mt-1">
                            {new Date(activity.created_at).toLocaleString()}
                        </div>
                    </div>
                    <div className="text-right">
                        <span className={`px-2 py-1 text-xs rounded-full ${
                            activity.priority === 1 ? 'bg-red-100 text-red-700' :
                            activity.priority === 2 ? 'bg-orange-100 text-orange-700' :
                            'bg-gray-100 text-gray-600'
                        }`}>
                            P{activity.priority}
                        </span>
                    </div>
                </div>
            );
        }

        // Dashboard View
        function Dashboard({ stats, items, hats }) {
            return (
                <div className="p-8 animate-fadeIn">
                    <div className="flex items-center justify-between mb-8">
                        <div>
                            <h1 className="text-3xl font-bold text-gray-900">Dashboard</h1>
                            <p className="text-gray-500 mt-1">Your life at a glance</p>
                        </div>
                        <button className="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors flex items-center">
                            <Icon name="refresh" className="w-4 h-4 mr-2" />
                            Refresh
                        </button>
                    </div>

                    <div className="grid grid-cols-4 gap-6 mb-8">
                        <StatCard label="Total Items" value={stats.total_items || 0} color="text-blue-600" icon="inbox" />
                        <StatCard label="Memories" value={stats.total_memories || 0} color="text-purple-600" icon="learning" />
                        <StatCard label="Active Hats" value={hats.filter(h => h.is_active).length} color="text-pink-600" icon="hats" />
                        <StatCard
                            label="Agent Status"
                            value={stats.agent_running ? 'Active' : 'Idle'}
                            color={stats.agent_running ? 'text-green-600' : 'text-gray-600'}
                            icon="chat"
                        />
                    </div>

                    <div className="grid grid-cols-3 gap-6">
                        <div className="col-span-2">
                            <div className="bg-white rounded-xl shadow-sm">
                                <div className="px-6 py-4 border-b border-gray-100">
                                    <h2 className="font-semibold text-lg">Recent Activity</h2>
                                </div>
                                <div className="divide-y divide-gray-50 max-h-96 overflow-auto scrollbar-hide">
                                    {items.slice(0, 10).map((item, i) => (
                                        <ActivityItem key={item.id || i} activity={item} />
                                    ))}
                                    {items.length === 0 && (
                                        <div className="p-8 text-center text-gray-400">
                                            No recent activity
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>

                        <div>
                            <div className="bg-white rounded-xl shadow-sm">
                                <div className="px-6 py-4 border-b border-gray-100">
                                    <h2 className="font-semibold text-lg">Your Hats</h2>
                                </div>
                                <div className="p-4 space-y-3">
                                    {hats.map(hat => (
                                        <div
                                            key={hat.id}
                                            className="flex items-center p-3 rounded-lg hover:bg-gray-50 transition-colors cursor-pointer"
                                            style={{ borderLeft: `4px solid ${hat.color}` }}
                                        >
                                            <span className="text-2xl mr-3">{hat.icon}</span>
                                            <div>
                                                <div className="font-medium">{hat.name}</div>
                                                <div className="text-xs text-gray-500">{hat.id}</div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Inbox View
        function Inbox({ items, hats }) {
            const [filter, setFilter] = useState('');
            const [statusFilter, setStatusFilter] = useState('');

            const filteredItems = items.filter(item => {
                if (filter && item.hat_id !== filter) return false;
                if (statusFilter && item.status !== statusFilter) return false;
                return true;
            });

            return (
                <div className="p-8 animate-fadeIn">
                    <div className="flex items-center justify-between mb-6">
                        <div>
                            <h1 className="text-3xl font-bold text-gray-900">Inbox</h1>
                            <p className="text-gray-500 mt-1">{filteredItems.length} items</p>
                        </div>
                        <div className="flex gap-4">
                            <select
                                value={filter}
                                onChange={e => setFilter(e.target.value)}
                                className="px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                            >
                                <option value="">All Hats</option>
                                {hats.map(hat => (
                                    <option key={hat.id} value={hat.id}>{hat.icon} {hat.name}</option>
                                ))}
                            </select>
                            <select
                                value={statusFilter}
                                onChange={e => setStatusFilter(e.target.value)}
                                className="px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                            >
                                <option value="">All Status</option>
                                <option value="pending">Pending</option>
                                <option value="processing">Processing</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                    </div>

                    <div className="space-y-4">
                        {filteredItems.map((item, i) => (
                            <div key={item.id || i} className="bg-white rounded-xl p-6 shadow-sm hover-lift transition-all animate-slideIn" style={{animationDelay: `${i * 50}ms`}}>
                                <div className="flex items-start justify-between">
                                    <div className="flex-1">
                                        <div className="flex items-center gap-2 mb-2">
                                            <span className="px-2 py-1 text-xs rounded-full bg-primary-100 text-primary-700">
                                                {item.hat_id}
                                            </span>
                                            <span className="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-600">
                                                {item.type}
                                            </span>
                                            <span className="text-sm text-gray-400">
                                                {new Date(item.created_at).toLocaleString()}
                                            </span>
                                        </div>
                                        <h3 className="font-semibold text-lg text-gray-900">{item.subject || 'No subject'}</h3>
                                        <p className="text-gray-500">{item.from || 'Unknown sender'}</p>
                                        {item.summary && <p className="mt-3 text-gray-600">{item.summary}</p>}
                                    </div>
                                    <div className="text-right ml-4">
                                        <div className={`text-sm font-semibold ${
                                            item.priority === 1 ? 'text-red-600' :
                                            item.priority === 2 ? 'text-orange-600' :
                                            item.priority === 3 ? 'text-yellow-600' :
                                            'text-gray-500'
                                        }`}>
                                            Priority {item.priority}
                                        </div>
                                        {item.sentiment && (
                                            <div className="text-xs text-gray-400 mt-1">{item.sentiment}</div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        ))}
                        {filteredItems.length === 0 && (
                            <div className="text-center py-12 text-gray-400">
                                <Icon name="inbox" className="w-12 h-12 mx-auto mb-4 opacity-50" />
                                <p>No items match your filters</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // Hats View
        function HatsView({ hats }) {
            return (
                <div className="p-8 animate-fadeIn">
                    <div className="mb-8">
                        <h1 className="text-3xl font-bold text-gray-900">Your Hats</h1>
                        <p className="text-gray-500 mt-1">Life contexts that organize your items</p>
                    </div>

                    <div className="grid grid-cols-3 gap-6">
                        {hats.map((hat, i) => (
                            <div
                                key={hat.id}
                                className="bg-white rounded-xl p-6 shadow-sm hover-lift transition-all animate-slideIn cursor-pointer"
                                style={{ borderTop: `4px solid ${hat.color}`, animationDelay: `${i * 100}ms` }}
                            >
                                <div className="flex items-center mb-4">
                                    <span className="text-4xl mr-4">{hat.icon}</span>
                                    <div>
                                        <h3 className="font-semibold text-xl">{hat.name}</h3>
                                        <p className="text-sm text-gray-500">{hat.id}</p>
                                    </div>
                                </div>
                                <p className="text-gray-600 mb-4">{hat.description || 'No description'}</p>
                                <div className="flex items-center gap-2">
                                    <span className={`px-3 py-1 text-sm rounded-full ${hat.is_active ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'}`}>
                                        {hat.is_active ? 'Active' : 'Inactive'}
                                    </span>
                                    {hat.is_system && (
                                        <span className="px-3 py-1 text-sm rounded-full bg-blue-100 text-blue-700">System</span>
                                    )}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        // Recommendations View
        function Recommendations() {
            const [recommendations, setRecommendations] = useState([]);
            const [nudges, setNudges] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                Promise.all([
                    api('/recommendations').catch(() => ({ recommendations: [] })),
                    api('/nudges').catch(() => ({ nudges: [] }))
                ]).then(([recsData, nudgesData]) => {
                    setRecommendations(recsData.recommendations || []);
                    setNudges(nudgesData.nudges || []);
                    setLoading(false);
                });
            }, []);

            const getPriorityStyle = (priority) => {
                switch(priority) {
                    case 1: return 'border-l-4 border-red-500 bg-red-50';
                    case 2: return 'border-l-4 border-orange-500 bg-orange-50';
                    case 3: return 'border-l-4 border-yellow-500 bg-yellow-50';
                    default: return 'border-l-4 border-gray-300 bg-gray-50';
                }
            };

            return (
                <div className="p-8 animate-fadeIn">
                    <div className="mb-8">
                        <h1 className="text-3xl font-bold text-gray-900">Recommendations</h1>
                        <p className="text-gray-500 mt-1">Proactive suggestions from your digital twin</p>
                    </div>

                    {loading ? (
                        <div className="flex justify-center py-12">
                            <div className="animate-pulse text-gray-400">Loading recommendations...</div>
                        </div>
                    ) : (
                        <div className="grid grid-cols-2 gap-6">
                            <div>
                                <h2 className="text-xl font-semibold mb-4 flex items-center">
                                    <Icon name="recommendations" className="w-6 h-6 mr-2 text-primary-600" />
                                    Active Recommendations
                                </h2>
                                <div className="space-y-4">
                                    {recommendations.map((rec, i) => (
                                        <div key={rec.id || i} className={`rounded-xl p-6 shadow-sm ${getPriorityStyle(rec.priority)}`}>
                                            <h3 className="font-semibold text-lg mb-2">{rec.title}</h3>
                                            <p className="text-gray-600 mb-4">{rec.description}</p>
                                            <div className="flex gap-2">
                                                {(rec.actions || []).map((action, j) => (
                                                    <button
                                                        key={j}
                                                        className={`px-4 py-2 rounded-lg text-sm ${
                                                            action.is_primary
                                                                ? 'bg-primary-600 text-white hover:bg-primary-700'
                                                                : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                                        }`}
                                                    >
                                                        {action.label}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                    ))}
                                    {recommendations.length === 0 && (
                                        <div className="text-center py-8 text-gray-400 bg-white rounded-xl">
                                            No active recommendations
                                        </div>
                                    )}
                                </div>
                            </div>

                            <div>
                                <h2 className="text-xl font-semibold mb-4 flex items-center">
                                    <Icon name="bell" className="w-6 h-6 mr-2 text-secondary-600" />
                                    Nudges
                                </h2>
                                <div className="space-y-4">
                                    {nudges.map((nudge, i) => (
                                        <div key={nudge.id || i} className="bg-white rounded-xl p-6 shadow-sm hover-lift transition-all">
                                            <div className="flex items-start">
                                                <span className="text-2xl mr-4">{nudge.icon || 'üí°'}</span>
                                                <div className="flex-1">
                                                    <h3 className="font-semibold">{nudge.title}</h3>
                                                    <p className="text-gray-600 text-sm mt-1">{nudge.body}</p>
                                                </div>
                                                <span className={`px-2 py-1 text-xs rounded-full ${
                                                    nudge.urgency === 'immediate' ? 'bg-red-100 text-red-700' :
                                                    nudge.urgency === 'high' ? 'bg-orange-100 text-orange-700' :
                                                    'bg-gray-100 text-gray-600'
                                                }`}>
                                                    {nudge.urgency}
                                                </span>
                                            </div>
                                        </div>
                                    ))}
                                    {nudges.length === 0 && (
                                        <div className="text-center py-8 text-gray-400 bg-white rounded-xl">
                                            No pending nudges
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Learning View
        function LearningView() {
            const [understanding, setUnderstanding] = useState(null);
            const [patterns, setPatterns] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                Promise.all([
                    api('/learning/understanding').catch(() => ({})),
                    api('/learning/patterns').catch(() => ({ patterns: [] }))
                ]).then(([u, p]) => {
                    setUnderstanding(u);
                    setPatterns(p.patterns || []);
                    setLoading(false);
                });
            }, []);

            return (
                <div className="p-8 animate-fadeIn">
                    <div className="mb-8">
                        <h1 className="text-3xl font-bold text-gray-900">Behavioral Learning</h1>
                        <p className="text-gray-500 mt-1">How your digital twin understands you</p>
                    </div>

                    {loading ? (
                        <div className="flex justify-center py-12">
                            <div className="animate-pulse text-gray-400">Loading insights...</div>
                        </div>
                    ) : (
                        <div className="grid grid-cols-2 gap-6">
                            <div className="bg-white rounded-xl p-6 shadow-sm">
                                <h2 className="text-xl font-semibold mb-4">Understanding Score</h2>
                                <div className="relative pt-1">
                                    <div className="flex mb-2 items-center justify-between">
                                        <span className="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-primary-600 bg-primary-100">
                                            Confidence
                                        </span>
                                        <span className="text-xs font-semibold inline-block text-primary-600">
                                            {Math.round((understanding?.confidence || 0) * 100)}%
                                        </span>
                                    </div>
                                    <div className="overflow-hidden h-3 mb-4 text-xs flex rounded-full bg-primary-100">
                                        <div
                                            style={{ width: `${(understanding?.confidence || 0) * 100}%` }}
                                            className="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-primary-600 transition-all duration-500"
                                        ></div>
                                    </div>
                                </div>
                                <div className="grid grid-cols-2 gap-4 mt-4">
                                    <div className="text-center p-4 bg-gray-50 rounded-lg">
                                        <div className="text-2xl font-bold text-primary-600">{understanding?.total_signals || 0}</div>
                                        <div className="text-sm text-gray-500">Signals Captured</div>
                                    </div>
                                    <div className="text-center p-4 bg-gray-50 rounded-lg">
                                        <div className="text-2xl font-bold text-secondary-600">{patterns.length}</div>
                                        <div className="text-sm text-gray-500">Patterns Detected</div>
                                    </div>
                                </div>
                            </div>

                            <div className="bg-white rounded-xl p-6 shadow-sm">
                                <h2 className="text-xl font-semibold mb-4">Detected Patterns</h2>
                                <div className="space-y-3 max-h-64 overflow-auto scrollbar-hide">
                                    {patterns.slice(0, 5).map((pattern, i) => (
                                        <div key={i} className="p-3 bg-gray-50 rounded-lg">
                                            <div className="flex items-center justify-between">
                                                <span className="font-medium text-gray-700">{pattern.type}</span>
                                                <span className="text-xs text-primary-600">{Math.round(pattern.confidence * 100)}%</span>
                                            </div>
                                            <p className="text-sm text-gray-500 mt-1">{pattern.description || 'Pattern detected'}</p>
                                        </div>
                                    ))}
                                    {patterns.length === 0 && (
                                        <div className="text-center py-4 text-gray-400">
                                            No patterns detected yet
                                        </div>
                                    )}
                                </div>
                            </div>

                            <div className="col-span-2 bg-white rounded-xl p-6 shadow-sm">
                                <h2 className="text-xl font-semibold mb-4">Sender Insights</h2>
                                <div className="grid grid-cols-4 gap-4">
                                    {Object.entries(understanding?.sender_profiles || {}).slice(0, 8).map(([email, profile]) => (
                                        <div key={email} className="p-4 bg-gray-50 rounded-lg">
                                            <div className="font-medium text-sm truncate" title={email}>{email}</div>
                                            <div className="text-xs text-gray-500 mt-1">
                                                Priority: {profile.priority || 'Unknown'}
                                            </div>
                                        </div>
                                    ))}
                                    {Object.keys(understanding?.sender_profiles || {}).length === 0 && (
                                        <div className="col-span-4 text-center py-4 text-gray-400">
                                            No sender data collected yet
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Chat View
        function ChatView() {
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(false);
            const messagesEndRef = useRef(null);

            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            };

            useEffect(() => {
                scrollToBottom();
            }, [messages]);

            const sendMessage = async (e) => {
                e.preventDefault();
                if (!input.trim() || loading) return;

                const userMessage = { role: 'user', content: input };
                setMessages(prev => [...prev, userMessage]);
                setInput('');
                setLoading(true);

                try {
                    const data = await api('/agent/chat', {
                        method: 'POST',
                        body: JSON.stringify({ message: input })
                    });
                    setMessages(prev => [...prev, { role: 'assistant', content: data.response }]);
                } catch (err) {
                    setMessages(prev => [...prev, { role: 'error', content: 'Failed to get response. Please try again.' }]);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="p-8 h-full flex flex-col animate-fadeIn">
                    <div className="mb-6">
                        <h1 className="text-3xl font-bold text-gray-900">Agent Chat</h1>
                        <p className="text-gray-500 mt-1">Talk to your digital twin</p>
                    </div>

                    <div className="flex-1 bg-white rounded-xl shadow-sm flex flex-col overflow-hidden">
                        <div className="flex-1 overflow-auto p-6 space-y-4">
                            {messages.length === 0 && (
                                <div className="text-center text-gray-400 py-12">
                                    <Icon name="chat" className="w-12 h-12 mx-auto mb-4 opacity-50" />
                                    <p>Start a conversation with your AI agent</p>
                                </div>
                            )}
                            {messages.map((msg, i) => (
                                <div
                                    key={i}
                                    className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'} animate-fadeIn`}
                                >
                                    <div className={`max-w-xl px-4 py-3 rounded-2xl ${
                                        msg.role === 'user'
                                            ? 'bg-primary-600 text-white'
                                            : msg.role === 'error'
                                            ? 'bg-red-100 text-red-700'
                                            : 'bg-gray-100 text-gray-800'
                                    }`}>
                                        {msg.role === 'assistant' && (
                                            <div className="text-xs text-primary-600 mb-1 font-medium">ü§ñ Agent</div>
                                        )}
                                        <p className="whitespace-pre-wrap">{msg.content}</p>
                                    </div>
                                </div>
                            ))}
                            {loading && (
                                <div className="flex justify-start animate-fadeIn">
                                    <div className="bg-gray-100 text-gray-600 px-4 py-3 rounded-2xl">
                                        <div className="flex items-center space-x-2">
                                            <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                                            <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{animationDelay: '0.2s'}}></div>
                                            <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{animationDelay: '0.4s'}}></div>
                                        </div>
                                    </div>
                                </div>
                            )}
                            <div ref={messagesEndRef} />
                        </div>

                        <form onSubmit={sendMessage} className="p-4 border-t border-gray-100 flex gap-4">
                            <input
                                type="text"
                                value={input}
                                onChange={e => setInput(e.target.value)}
                                placeholder="Type a message..."
                                className="flex-1 px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all"
                                disabled={loading}
                            />
                            <button
                                type="submit"
                                disabled={loading || !input.trim()}
                                className="px-6 py-3 bg-primary-600 text-white rounded-xl hover:bg-primary-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all flex items-center"
                            >
                                <Icon name="send" className="w-5 h-5" />
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        // Spaces View
        function SpacesView() {
            const [spaces, setSpaces] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                api('/spaces').then(data => {
                    setSpaces(Array.isArray(data) ? data : []);
                    setLoading(false);
                }).catch(() => setLoading(false));
            }, []);

            const getSpaceIcon = (provider) => {
                const icons = { gmail: 'üìß', outlook: 'üì¨', calendar: 'üìÖ', gdrive: 'üìÅ', dropbox: 'üì¶' };
                return icons[provider] || 'üì°';
            };

            return (
                <div className="p-8 animate-fadeIn">
                    <div className="mb-8">
                        <h1 className="text-3xl font-bold text-gray-900">Connected Spaces</h1>
                        <p className="text-gray-500 mt-1">Integrations and data sources</p>
                    </div>

                    {loading ? (
                        <div className="flex justify-center py-12">
                            <div className="animate-pulse text-gray-400">Loading spaces...</div>
                        </div>
                    ) : spaces.length === 0 ? (
                        <div className="text-center py-12 bg-white rounded-xl shadow-sm">
                            <Icon name="spaces" className="w-16 h-16 mx-auto mb-4 text-gray-300" />
                            <h3 className="text-lg font-medium text-gray-700 mb-2">No spaces connected</h3>
                            <p className="text-gray-500 mb-4">Connect your first space using the CLI</p>
                            <code className="bg-gray-100 px-4 py-2 rounded-lg text-sm">ql spaces add gmail</code>
                        </div>
                    ) : (
                        <div className="space-y-4">
                            {spaces.map((space, i) => (
                                <div key={space.id || i} className="bg-white rounded-xl p-6 shadow-sm flex items-center justify-between hover-lift transition-all">
                                    <div className="flex items-center">
                                        <span className="text-4xl mr-4">{getSpaceIcon(space.provider)}</span>
                                        <div>
                                            <h3 className="font-semibold text-lg">{space.name}</h3>
                                            <p className="text-gray-500">{space.provider} - {space.type}</p>
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-4">
                                        <span className={`px-3 py-1 rounded-full text-sm ${space.is_connected ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                            {space.is_connected ? 'Connected' : 'Disconnected'}
                                        </span>
                                        {space.last_sync_at && (
                                            <span className="text-sm text-gray-400">
                                                Last sync: {new Date(space.last_sync_at).toLocaleString()}
                                            </span>
                                        )}
                                        <button className="p-2 text-gray-400 hover:text-primary-600 transition-colors">
                                            <Icon name="refresh" className="w-5 h-5" />
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        }

        // Toggle Switch Component
        function Toggle({ enabled, onChange, disabled }) {
            return (
                <button
                    onClick={() => !disabled && onChange(!enabled)}
                    disabled={disabled}
                    className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${
                        enabled ? 'bg-primary-600' : 'bg-gray-300'
                    } ${disabled ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer'}`}
                >
                    <span className={`inline-block h-4 w-4 transform rounded-full bg-white transition ${
                        enabled ? 'translate-x-6' : 'translate-x-1'
                    }`} />
                </button>
            );
        }

        // Settings View - Full Implementation
        function Settings() {
            const [settings, setSettings] = useState(null);
            const [hatSettings, setHatSettings] = useState([]);
            const [loading, setLoading] = useState(true);
            const [saving, setSaving] = useState(false);
            const [activeSection, setActiveSection] = useState('profile');
            const [message, setMessage] = useState(null);

            useEffect(() => {
                Promise.all([
                    api('/settings').catch(() => ({})),
                    api('/settings/hats').catch(() => ({ hat_settings: [] }))
                ]).then(([s, hs]) => {
                    setSettings(s);
                    setHatSettings(hs.hat_settings || []);
                    setLoading(false);
                });
            }, []);

            const updateSettings = async (updates) => {
                setSaving(true);
                try {
                    const updated = await api('/settings', {
                        method: 'PUT',
                        body: JSON.stringify({ ...settings, ...updates })
                    });
                    setSettings(updated);
                    setMessage({ type: 'success', text: 'Settings saved' });
                    setTimeout(() => setMessage(null), 3000);
                } catch (err) {
                    setMessage({ type: 'error', text: 'Failed to save settings' });
                }
                setSaving(false);
            };

            const sections = [
                { id: 'profile', label: 'Profile', icon: 'üë§' },
                { id: 'agent', label: 'Agent Behavior', icon: 'ü§ñ' },
                { id: 'hats', label: 'Hat Settings', icon: 'üé©' },
                { id: 'notifications', label: 'Notifications', icon: 'üîî' },
                { id: 'privacy', label: 'Privacy & Data', icon: 'üîí' },
                { id: 'about', label: 'About', icon: '‚ÑπÔ∏è' }
            ];

            if (loading) {
                return (
                    <div className="p-8 flex justify-center items-center h-full">
                        <div className="animate-pulse text-gray-400">Loading settings...</div>
                    </div>
                );
            }

            return (
                <div className="p-8 animate-fadeIn">
                    <div className="flex items-center justify-between mb-8">
                        <div>
                            <h1 className="text-3xl font-bold text-gray-900">Settings</h1>
                            <p className="text-gray-500 mt-1">Configure your digital twin</p>
                        </div>
                        {message && (
                            <div className={`px-4 py-2 rounded-lg ${
                                message.type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'
                            }`}>
                                {message.text}
                            </div>
                        )}
                    </div>

                    <div className="flex gap-8">
                        {/* Sidebar */}
                        <div className="w-64 shrink-0">
                            <div className="bg-white rounded-xl shadow-sm overflow-hidden">
                                {sections.map(section => (
                                    <button
                                        key={section.id}
                                        onClick={() => setActiveSection(section.id)}
                                        className={`w-full px-4 py-3 flex items-center text-left transition-colors ${
                                            activeSection === section.id
                                                ? 'bg-primary-50 text-primary-700 border-l-4 border-primary-600'
                                                : 'hover:bg-gray-50 text-gray-700'
                                        }`}
                                    >
                                        <span className="mr-3">{section.icon}</span>
                                        <span className="font-medium">{section.label}</span>
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* Content */}
                        <div className="flex-1">
                            {activeSection === 'profile' && (
                                <div className="bg-white rounded-xl p-6 shadow-sm">
                                    <h2 className="text-xl font-semibold mb-6">Profile Settings</h2>
                                    <div className="space-y-6">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">Display Name</label>
                                            <input
                                                type="text"
                                                value={settings.display_name || ''}
                                                onChange={e => setSettings({ ...settings, display_name: e.target.value })}
                                                onBlur={() => updateSettings({ display_name: settings.display_name })}
                                                className="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">Timezone</label>
                                            <select
                                                value={settings.timezone || 'UTC'}
                                                onChange={e => updateSettings({ timezone: e.target.value })}
                                                className="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                            >
                                                <option value="UTC">UTC</option>
                                                <option value="America/New_York">Eastern Time</option>
                                                <option value="America/Chicago">Central Time</option>
                                                <option value="America/Denver">Mountain Time</option>
                                                <option value="America/Los_Angeles">Pacific Time</option>
                                                <option value="Europe/London">London</option>
                                                <option value="Europe/Paris">Paris</option>
                                                <option value="Asia/Tokyo">Tokyo</option>
                                                <option value="Asia/Kolkata">India</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeSection === 'agent' && (
                                <div className="bg-white rounded-xl p-6 shadow-sm">
                                    <h2 className="text-xl font-semibold mb-6">Agent Behavior</h2>
                                    <div className="space-y-6">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">Autonomy Mode</label>
                                            <div className="grid grid-cols-3 gap-4">
                                                {['supervised', 'assisted', 'autonomous'].map(mode => (
                                                    <button
                                                        key={mode}
                                                        onClick={() => updateSettings({ autonomy_mode: mode })}
                                                        className={`p-4 rounded-lg border-2 transition-all ${
                                                            settings.autonomy_mode === mode
                                                                ? 'border-primary-600 bg-primary-50'
                                                                : 'border-gray-200 hover:border-gray-300'
                                                        }`}
                                                    >
                                                        <div className="font-semibold capitalize">{mode}</div>
                                                        <div className="text-xs text-gray-500 mt-1">
                                                            {mode === 'supervised' && 'Always ask before acting'}
                                                            {mode === 'assisted' && 'Act on high-confidence tasks'}
                                                            {mode === 'autonomous' && 'Full autonomy within bounds'}
                                                        </div>
                                                    </button>
                                                ))}
                                            </div>
                                        </div>

                                        <div className="grid grid-cols-2 gap-6">
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Supervised Threshold ({Math.round((settings.supervised_threshold || 0.7) * 100)}%)
                                                </label>
                                                <input
                                                    type="range"
                                                    min="0.5"
                                                    max="1"
                                                    step="0.05"
                                                    value={settings.supervised_threshold || 0.7}
                                                    onChange={e => setSettings({ ...settings, supervised_threshold: parseFloat(e.target.value) })}
                                                    onMouseUp={() => updateSettings({ supervised_threshold: settings.supervised_threshold })}
                                                    className="w-full"
                                                />
                                                <p className="text-xs text-gray-500 mt-1">Confidence needed to suggest actions</p>
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Autonomous Threshold ({Math.round((settings.autonomous_threshold || 0.9) * 100)}%)
                                                </label>
                                                <input
                                                    type="range"
                                                    min="0.7"
                                                    max="1"
                                                    step="0.05"
                                                    value={settings.autonomous_threshold || 0.9}
                                                    onChange={e => setSettings({ ...settings, autonomous_threshold: parseFloat(e.target.value) })}
                                                    onMouseUp={() => updateSettings({ autonomous_threshold: settings.autonomous_threshold })}
                                                    className="w-full"
                                                />
                                                <p className="text-xs text-gray-500 mt-1">Confidence needed to act automatically</p>
                                            </div>
                                        </div>

                                        <div className="space-y-4 pt-4 border-t">
                                            <div className="flex items-center justify-between">
                                                <div>
                                                    <div className="font-medium">Enable Learning</div>
                                                    <div className="text-sm text-gray-500">Learn from your behavior patterns</div>
                                                </div>
                                                <Toggle
                                                    enabled={settings.learning_enabled}
                                                    onChange={v => updateSettings({ learning_enabled: v })}
                                                />
                                            </div>
                                            <div className="flex items-center justify-between">
                                                <div>
                                                    <div className="font-medium">Proactive Suggestions</div>
                                                    <div className="text-sm text-gray-500">Offer recommendations without being asked</div>
                                                </div>
                                                <Toggle
                                                    enabled={settings.proactive_enabled}
                                                    onChange={v => updateSettings({ proactive_enabled: v })}
                                                />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeSection === 'hats' && (
                                <div className="bg-white rounded-xl p-6 shadow-sm">
                                    <h2 className="text-xl font-semibold mb-6">Hat-Specific Settings</h2>
                                    <p className="text-gray-500 mb-6">Configure behavior for each life context</p>
                                    <div className="space-y-4">
                                        {hatSettings.length === 0 ? (
                                            <div className="text-center py-8 text-gray-400">
                                                No hat settings configured. Add hats using the CLI.
                                            </div>
                                        ) : (
                                            hatSettings.map(hat => (
                                                <div key={hat.hat_id} className="p-4 border border-gray-200 rounded-lg">
                                                    <div className="flex items-center justify-between mb-4">
                                                        <div className="font-medium">{hat.hat_id}</div>
                                                        <Toggle
                                                            enabled={hat.enabled}
                                                            onChange={async (v) => {
                                                                await api(`/settings/hats/${hat.hat_id}`, {
                                                                    method: 'PUT',
                                                                    body: JSON.stringify({ ...hat, enabled: v })
                                                                });
                                                                setHatSettings(hs => hs.map(h =>
                                                                    h.hat_id === hat.hat_id ? { ...h, enabled: v } : h
                                                                ));
                                                            }}
                                                        />
                                                    </div>
                                                    <div className="grid grid-cols-3 gap-4 text-sm">
                                                        <label className="flex items-center">
                                                            <input
                                                                type="checkbox"
                                                                checked={hat.auto_respond}
                                                                onChange={e => {
                                                                    api(`/settings/hats/${hat.hat_id}`, {
                                                                        method: 'PUT',
                                                                        body: JSON.stringify({ ...hat, auto_respond: e.target.checked })
                                                                    });
                                                                }}
                                                                className="mr-2"
                                                            />
                                                            Auto-respond
                                                        </label>
                                                        <label className="flex items-center">
                                                            <input
                                                                type="checkbox"
                                                                checked={hat.auto_prioritize}
                                                                onChange={e => {
                                                                    api(`/settings/hats/${hat.hat_id}`, {
                                                                        method: 'PUT',
                                                                        body: JSON.stringify({ ...hat, auto_prioritize: e.target.checked })
                                                                    });
                                                                }}
                                                                className="mr-2"
                                                            />
                                                            Auto-prioritize
                                                        </label>
                                                        <label className="flex items-center">
                                                            <input
                                                                type="checkbox"
                                                                checked={hat.notification_enabled}
                                                                onChange={e => {
                                                                    api(`/settings/hats/${hat.hat_id}`, {
                                                                        method: 'PUT',
                                                                        body: JSON.stringify({ ...hat, notification_enabled: e.target.checked })
                                                                    });
                                                                }}
                                                                className="mr-2"
                                                            />
                                                            Notifications
                                                        </label>
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                </div>
                            )}

                            {activeSection === 'notifications' && (
                                <div className="bg-white rounded-xl p-6 shadow-sm">
                                    <h2 className="text-xl font-semibold mb-6">Notification Settings</h2>
                                    <div className="space-y-6">
                                        <div className="flex items-center justify-between">
                                            <div>
                                                <div className="font-medium">Enable Notifications</div>
                                                <div className="text-sm text-gray-500">Receive alerts and recommendations</div>
                                            </div>
                                            <Toggle
                                                enabled={settings.notifications_enabled}
                                                onChange={v => updateSettings({ notifications_enabled: v })}
                                            />
                                        </div>

                                        <div className="border-t pt-6">
                                            <div className="flex items-center justify-between mb-4">
                                                <div>
                                                    <div className="font-medium">Quiet Hours</div>
                                                    <div className="text-sm text-gray-500">Pause notifications during specific times</div>
                                                </div>
                                                <Toggle
                                                    enabled={settings.quiet_hours_enabled}
                                                    onChange={v => updateSettings({ quiet_hours_enabled: v })}
                                                />
                                            </div>
                                            {settings.quiet_hours_enabled && (
                                                <div className="grid grid-cols-2 gap-4 mt-4">
                                                    <div>
                                                        <label className="block text-sm text-gray-600 mb-1">Start Time</label>
                                                        <input
                                                            type="time"
                                                            value={settings.quiet_hours_start || '22:00'}
                                                            onChange={e => updateSettings({ quiet_hours_start: e.target.value })}
                                                            className="w-full px-3 py-2 border border-gray-200 rounded-lg"
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="block text-sm text-gray-600 mb-1">End Time</label>
                                                        <input
                                                            type="time"
                                                            value={settings.quiet_hours_end || '08:00'}
                                                            onChange={e => updateSettings({ quiet_hours_end: e.target.value })}
                                                            className="w-full px-3 py-2 border border-gray-200 rounded-lg"
                                                        />
                                                    </div>
                                                </div>
                                            )}
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                Minimum Urgency Level ({settings.min_urgency_for_notification || 2})
                                            </label>
                                            <input
                                                type="range"
                                                min="1"
                                                max="5"
                                                step="1"
                                                value={settings.min_urgency_for_notification || 2}
                                                onChange={e => updateSettings({ min_urgency_for_notification: parseInt(e.target.value) })}
                                                className="w-full"
                                            />
                                            <div className="flex justify-between text-xs text-gray-500 mt-1">
                                                <span>All</span>
                                                <span>Critical only</span>
                                            </div>
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">Email Digest</label>
                                            <select
                                                value={settings.email_digest || 'daily'}
                                                onChange={e => updateSettings({ email_digest: e.target.value })}
                                                className="w-full px-4 py-2 border border-gray-200 rounded-lg"
                                            >
                                                <option value="none">Never</option>
                                                <option value="daily">Daily</option>
                                                <option value="weekly">Weekly</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeSection === 'privacy' && (
                                <div className="space-y-6">
                                    <div className="bg-white rounded-xl p-6 shadow-sm">
                                        <h2 className="text-xl font-semibold mb-6">Privacy & Data</h2>
                                        <div className="space-y-6">
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Data Retention ({settings.data_retention_days || 365} days)
                                                </label>
                                                <input
                                                    type="range"
                                                    min="30"
                                                    max="365"
                                                    step="30"
                                                    value={settings.data_retention_days || 365}
                                                    onChange={e => setSettings({ ...settings, data_retention_days: parseInt(e.target.value) })}
                                                    onMouseUp={() => updateSettings({ data_retention_days: settings.data_retention_days })}
                                                    className="w-full"
                                                />
                                                <div className="flex justify-between text-xs text-gray-500 mt-1">
                                                    <span>30 days</span>
                                                    <span>1 year</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="bg-white rounded-xl p-6 shadow-sm">
                                        <h2 className="text-xl font-semibold mb-4">Export & Delete</h2>
                                        <div className="space-y-4">
                                            <div className="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                                <div>
                                                    <div className="font-medium">Export All Data</div>
                                                    <div className="text-sm text-gray-500">Download a copy of all your data</div>
                                                </div>
                                                <a
                                                    href="/api/v1/settings/export"
                                                    className="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700"
                                                >
                                                    Export
                                                </a>
                                            </div>
                                            <div className="flex items-center justify-between p-4 bg-red-50 rounded-lg">
                                                <div>
                                                    <div className="font-medium text-red-700">Delete Account</div>
                                                    <div className="text-sm text-red-600">Permanently delete all data</div>
                                                </div>
                                                <button
                                                    onClick={async () => {
                                                        if (confirm('Are you sure? This cannot be undone.')) {
                                                            await api('/settings/delete', {
                                                                method: 'DELETE',
                                                                body: JSON.stringify({ confirm: true })
                                                            });
                                                            window.location.reload();
                                                        }
                                                    }}
                                                    className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700"
                                                >
                                                    Delete
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeSection === 'about' && (
                                <div className="bg-white rounded-xl p-6 shadow-sm">
                                    <h2 className="text-xl font-semibold mb-6">About QuantumLife</h2>
                                    <div className="space-y-4">
                                        <div className="flex justify-between py-3 border-b border-gray-100">
                                            <span className="text-gray-600">Version</span>
                                            <span className="font-mono">1.0.0</span>
                                        </div>
                                        <div className="flex justify-between py-3 border-b border-gray-100">
                                            <span className="text-gray-600">API Endpoint</span>
                                            <span className="font-mono text-sm">{window.location.origin}/api/v1</span>
                                        </div>
                                        <div className="flex justify-between py-3 border-b border-gray-100">
                                            <span className="text-gray-600">Build</span>
                                            <span className="font-mono text-sm">production</span>
                                        </div>
                                        <div className="mt-6 p-4 bg-gray-50 rounded-lg">
                                            <p className="text-sm text-gray-600">
                                                QuantumLife is your personal digital twin - an AI-powered life operating system
                                                that learns your patterns, manages your contexts, and helps you be more effective.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // Onboarding Wizard Component
        function OnboardingWizard({ onComplete }) {
            const [step, setStep] = useState(0);
            const [loading, setLoading] = useState(false);
            const [formData, setFormData] = useState({
                name: '',
                passphrase: '',
                confirmPassphrase: ''
            });
            const [error, setError] = useState(null);
            const [oauthUrl, setOauthUrl] = useState(null);

            const steps = [
                { id: 'welcome', title: 'Welcome', description: 'Get started with QuantumLife' },
                { id: 'identity', title: 'Create Identity', description: 'Set up your digital twin' },
                { id: 'gmail', title: 'Connect Gmail', description: 'Link your email (optional)' },
                { id: 'calendar', title: 'Connect Calendar', description: 'Sync your schedule (optional)' },
                { id: 'complete', title: 'All Set!', description: 'Start using QuantumLife' }
            ];

            const createIdentity = async () => {
                if (formData.passphrase !== formData.confirmPassphrase) {
                    setError('Passphrases do not match');
                    return;
                }
                if (formData.passphrase.length < 8) {
                    setError('Passphrase must be at least 8 characters');
                    return;
                }
                setLoading(true);
                setError(null);
                try {
                    await api('/setup/identity', {
                        method: 'POST',
                        body: JSON.stringify({ name: formData.name, passphrase: formData.passphrase })
                    });
                    setStep(2);
                } catch (err) {
                    setError('Failed to create identity. Please try again.');
                }
                setLoading(false);
            };

            const getOAuthUrl = async (provider) => {
                try {
                    const data = await api(`/setup/oauth/${provider}`);
                    window.open(data.oauth_url, '_blank', 'width=600,height=700');
                } catch (err) {
                    setError(`Failed to connect ${provider}`);
                }
            };

            const completeSetup = async () => {
                setLoading(true);
                try {
                    await api('/setup/complete', { method: 'POST' });
                    onComplete();
                } catch (err) {
                    setError('Failed to complete setup');
                }
                setLoading(false);
            };

            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl mx-4 overflow-hidden">
                        {/* Progress bar */}
                        <div className="bg-gray-50 px-8 py-4">
                            <div className="flex items-center justify-between mb-4">
                                {steps.map((s, i) => (
                                    <div key={s.id} className="flex items-center">
                                        <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium ${
                                            i < step ? 'bg-green-500 text-white' :
                                            i === step ? 'bg-primary-600 text-white' :
                                            'bg-gray-200 text-gray-500'
                                        }`}>
                                            {i < step ? <Icon name="check" className="w-4 h-4" /> : i + 1}
                                        </div>
                                        {i < steps.length - 1 && (
                                            <div className={`w-12 h-0.5 mx-2 ${i < step ? 'bg-green-500' : 'bg-gray-200'}`} />
                                        )}
                                    </div>
                                ))}
                            </div>
                            <div className="text-center">
                                <h2 className="text-xl font-bold text-gray-900">{steps[step].title}</h2>
                                <p className="text-gray-500 text-sm">{steps[step].description}</p>
                            </div>
                        </div>

                        {/* Content */}
                        <div className="p-8">
                            {error && (
                                <div className="mb-4 p-3 bg-red-100 text-red-700 rounded-lg text-sm">
                                    {error}
                                </div>
                            )}

                            {step === 0 && (
                                <div className="text-center">
                                    <div className="text-6xl mb-6">üß†</div>
                                    <h3 className="text-2xl font-bold mb-4">Welcome to QuantumLife</h3>
                                    <p className="text-gray-600 mb-8 max-w-md mx-auto">
                                        Your personal digital twin that learns your patterns, manages your life contexts,
                                        and helps you be more effective. Let's set things up!
                                    </p>
                                    <div className="space-y-4 text-left max-w-md mx-auto">
                                        <div className="flex items-start">
                                            <span className="text-2xl mr-3">üé©</span>
                                            <div>
                                                <div className="font-medium">Multiple Life Contexts</div>
                                                <div className="text-sm text-gray-500">Organize your life with "Hats" - work, family, health, hobbies</div>
                                            </div>
                                        </div>
                                        <div className="flex items-start">
                                            <span className="text-2xl mr-3">ü§ñ</span>
                                            <div>
                                                <div className="font-medium">AI-Powered Agent</div>
                                                <div className="text-sm text-gray-500">Learn your preferences and act on your behalf</div>
                                            </div>
                                        </div>
                                        <div className="flex items-start">
                                            <span className="text-2xl mr-3">üîí</span>
                                            <div>
                                                <div className="font-medium">Privacy-First</div>
                                                <div className="text-sm text-gray-500">Local-first with end-to-end encryption</div>
                                            </div>
                                        </div>
                                    </div>
                                    <button
                                        onClick={() => setStep(1)}
                                        className="mt-8 px-8 py-3 bg-primary-600 text-white rounded-lg hover:bg-primary-700 font-medium"
                                    >
                                        Get Started
                                    </button>
                                </div>
                            )}

                            {step === 1 && (
                                <div className="max-w-md mx-auto">
                                    <div className="space-y-6">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">Your Name</label>
                                            <input
                                                type="text"
                                                value={formData.name}
                                                onChange={e => setFormData({ ...formData, name: e.target.value })}
                                                placeholder="Enter your name"
                                                className="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">Create Passphrase</label>
                                            <input
                                                type="password"
                                                value={formData.passphrase}
                                                onChange={e => setFormData({ ...formData, passphrase: e.target.value })}
                                                placeholder="At least 8 characters"
                                                className="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                            />
                                            <p className="text-xs text-gray-500 mt-1">This encrypts your data. Don't forget it!</p>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">Confirm Passphrase</label>
                                            <input
                                                type="password"
                                                value={formData.confirmPassphrase}
                                                onChange={e => setFormData({ ...formData, confirmPassphrase: e.target.value })}
                                                placeholder="Re-enter passphrase"
                                                className="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                            />
                                        </div>
                                    </div>
                                    <div className="flex justify-between mt-8">
                                        <button
                                            onClick={() => setStep(0)}
                                            className="px-6 py-2 text-gray-600 hover:text-gray-900"
                                        >
                                            Back
                                        </button>
                                        <button
                                            onClick={createIdentity}
                                            disabled={loading || !formData.name || !formData.passphrase}
                                            className="px-8 py-3 bg-primary-600 text-white rounded-lg hover:bg-primary-700 disabled:opacity-50 disabled:cursor-not-allowed font-medium"
                                        >
                                            {loading ? 'Creating...' : 'Create Identity'}
                                        </button>
                                    </div>
                                </div>
                            )}

                            {step === 2 && (
                                <div className="text-center max-w-md mx-auto">
                                    <div className="text-6xl mb-6">üìß</div>
                                    <h3 className="text-xl font-bold mb-4">Connect Your Gmail</h3>
                                    <p className="text-gray-600 mb-8">
                                        Link your Gmail account so your digital twin can help manage your emails.
                                        This is optional - you can always do it later.
                                    </p>
                                    <button
                                        onClick={() => getOAuthUrl('gmail')}
                                        className="w-full px-6 py-3 border-2 border-gray-200 rounded-lg hover:border-primary-500 hover:bg-primary-50 flex items-center justify-center mb-4"
                                    >
                                        <img src="https://www.google.com/favicon.ico" className="w-5 h-5 mr-3" alt="" />
                                        Connect Gmail
                                    </button>
                                    <div className="flex justify-between mt-8">
                                        <button
                                            onClick={() => setStep(1)}
                                            className="px-6 py-2 text-gray-600 hover:text-gray-900"
                                        >
                                            Back
                                        </button>
                                        <button
                                            onClick={() => setStep(3)}
                                            className="px-8 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200"
                                        >
                                            Skip for Now
                                        </button>
                                    </div>
                                </div>
                            )}

                            {step === 3 && (
                                <div className="text-center max-w-md mx-auto">
                                    <div className="text-6xl mb-6">üìÖ</div>
                                    <h3 className="text-xl font-bold mb-4">Connect Your Calendar</h3>
                                    <p className="text-gray-600 mb-8">
                                        Sync your calendar to get smart scheduling suggestions
                                        and meeting preparation assistance.
                                    </p>
                                    <button
                                        onClick={() => getOAuthUrl('calendar')}
                                        className="w-full px-6 py-3 border-2 border-gray-200 rounded-lg hover:border-primary-500 hover:bg-primary-50 flex items-center justify-center mb-4"
                                    >
                                        <img src="https://calendar.google.com/googlecalendar/images/favicon_v2018_256.png" className="w-5 h-5 mr-3" alt="" />
                                        Connect Google Calendar
                                    </button>
                                    <div className="flex justify-between mt-8">
                                        <button
                                            onClick={() => setStep(2)}
                                            className="px-6 py-2 text-gray-600 hover:text-gray-900"
                                        >
                                            Back
                                        </button>
                                        <button
                                            onClick={() => setStep(4)}
                                            className="px-8 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200"
                                        >
                                            Skip for Now
                                        </button>
                                    </div>
                                </div>
                            )}

                            {step === 4 && (
                                <div className="text-center">
                                    <div className="text-6xl mb-6">üéâ</div>
                                    <h3 className="text-2xl font-bold mb-4">You're All Set!</h3>
                                    <p className="text-gray-600 mb-8 max-w-md mx-auto">
                                        Your digital twin is ready to learn and help. Start by adding some
                                        life contexts (Hats) or just explore the dashboard.
                                    </p>
                                    <div className="grid grid-cols-3 gap-4 max-w-lg mx-auto mb-8">
                                        <div className="p-4 bg-gray-50 rounded-lg text-center">
                                            <div className="text-2xl mb-2">üíº</div>
                                            <div className="text-sm font-medium">Work Hat</div>
                                        </div>
                                        <div className="p-4 bg-gray-50 rounded-lg text-center">
                                            <div className="text-2xl mb-2">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
                                            <div className="text-sm font-medium">Family Hat</div>
                                        </div>
                                        <div className="p-4 bg-gray-50 rounded-lg text-center">
                                            <div className="text-2xl mb-2">üèÉ</div>
                                            <div className="text-sm font-medium">Health Hat</div>
                                        </div>
                                    </div>
                                    <button
                                        onClick={completeSetup}
                                        disabled={loading}
                                        className="px-8 py-3 bg-primary-600 text-white rounded-lg hover:bg-primary-700 font-medium"
                                    >
                                        {loading ? 'Setting up...' : 'Start Using QuantumLife'}
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // Notifications Bell Component
        function NotificationsBell() {
            const [open, setOpen] = useState(false);
            const [notifications, setNotifications] = useState([]);
            const [unreadCount, setUnreadCount] = useState(0);
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                fetchUnreadCount();
                const interval = setInterval(fetchUnreadCount, 30000);
                return () => clearInterval(interval);
            }, []);

            const fetchUnreadCount = async () => {
                try {
                    const data = await api('/notifications/unread-count');
                    setUnreadCount(data.count || 0);
                } catch (err) {}
            };

            const fetchNotifications = async () => {
                setLoading(true);
                try {
                    const data = await api('/notifications?limit=10&dismissed=false');
                    setNotifications(data.notifications || []);
                } catch (err) {}
                setLoading(false);
            };

            const markAsRead = async (id) => {
                try {
                    await api(`/notifications/${id}/read`, { method: 'POST' });
                    setNotifications(ns => ns.map(n => n.id === id ? { ...n, is_read: true } : n));
                    setUnreadCount(c => Math.max(0, c - 1));
                } catch (err) {}
            };

            const markAllAsRead = async () => {
                try {
                    await api('/notifications/read-all', { method: 'POST' });
                    setNotifications(ns => ns.map(n => ({ ...n, is_read: true })));
                    setUnreadCount(0);
                } catch (err) {}
            };

            const dismiss = async (id) => {
                try {
                    await api(`/notifications/${id}/dismiss`, { method: 'POST' });
                    setNotifications(ns => ns.filter(n => n.id !== id));
                } catch (err) {}
            };

            const handleOpen = () => {
                setOpen(!open);
                if (!open) fetchNotifications();
            };

            const getTypeIcon = (type) => {
                const icons = {
                    recommendation: 'üí°',
                    action_required: '‚ö°',
                    action_complete: '‚úÖ',
                    insight: 'üîç',
                    reminder: '‚è∞',
                    alert: 'üö®',
                    digest: 'üìä',
                    system: '‚öôÔ∏è'
                };
                return icons[type] || 'üì¨';
            };

            const getUrgencyColor = (urgency) => {
                if (urgency >= 4) return 'border-l-red-500';
                if (urgency >= 3) return 'border-l-orange-500';
                if (urgency >= 2) return 'border-l-yellow-500';
                return 'border-l-gray-300';
            };

            return (
                <div className="relative">
                    <button
                        onClick={handleOpen}
                        className="relative p-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors"
                    >
                        <Icon name="bell" className="w-6 h-6" />
                        {unreadCount > 0 && (
                            <span className="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center">
                                {unreadCount > 9 ? '9+' : unreadCount}
                            </span>
                        )}
                    </button>

                    {open && (
                        <>
                            <div className="fixed inset-0 z-40" onClick={() => setOpen(false)} />
                            <div className="absolute right-0 top-12 w-96 bg-white rounded-xl shadow-2xl border border-gray-100 z-50 overflow-hidden">
                                <div className="px-4 py-3 bg-gray-50 flex items-center justify-between border-b">
                                    <h3 className="font-semibold">Notifications</h3>
                                    {unreadCount > 0 && (
                                        <button
                                            onClick={markAllAsRead}
                                            className="text-sm text-primary-600 hover:text-primary-700"
                                        >
                                            Mark all read
                                        </button>
                                    )}
                                </div>
                                <div className="max-h-96 overflow-auto">
                                    {loading ? (
                                        <div className="p-8 text-center text-gray-400">Loading...</div>
                                    ) : notifications.length === 0 ? (
                                        <div className="p-8 text-center text-gray-400">
                                            <Icon name="bell" className="w-12 h-12 mx-auto mb-2 opacity-30" />
                                            <p>No notifications</p>
                                        </div>
                                    ) : (
                                        notifications.map(notif => (
                                            <div
                                                key={notif.id}
                                                className={`px-4 py-3 border-b border-l-4 ${getUrgencyColor(notif.urgency)} ${
                                                    notif.is_read ? 'bg-white' : 'bg-primary-50'
                                                } hover:bg-gray-50 transition-colors`}
                                            >
                                                <div className="flex items-start">
                                                    <span className="text-xl mr-3">{getTypeIcon(notif.type)}</span>
                                                    <div className="flex-1 min-w-0">
                                                        <div className="font-medium text-sm truncate">{notif.title}</div>
                                                        <div className="text-xs text-gray-500 mt-0.5 line-clamp-2">{notif.body}</div>
                                                        <div className="text-xs text-gray-400 mt-1">
                                                            {new Date(notif.created_at).toLocaleString()}
                                                        </div>
                                                    </div>
                                                    <div className="flex items-center ml-2 space-x-1">
                                                        {!notif.is_read && (
                                                            <button
                                                                onClick={() => markAsRead(notif.id)}
                                                                className="p-1 text-gray-400 hover:text-primary-600"
                                                                title="Mark as read"
                                                            >
                                                                <Icon name="check" className="w-4 h-4" />
                                                            </button>
                                                        )}
                                                        <button
                                                            onClick={() => dismiss(notif.id)}
                                                            className="p-1 text-gray-400 hover:text-red-600"
                                                            title="Dismiss"
                                                        >
                                                            <Icon name="close" className="w-4 h-4" />
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        ))
                                    )}
                                </div>
                                <div className="px-4 py-2 bg-gray-50 border-t text-center">
                                    <a href="#" onClick={(e) => { e.preventDefault(); setOpen(false); }} className="text-sm text-primary-600 hover:text-primary-700">
                                        View All
                                    </a>
                                </div>
                            </div>
                        </>
                    )}
                </div>
            );
        }

        // Main App
        function App() {
            const [currentView, setCurrentView] = useState('dashboard');
            const [identity, setIdentity] = useState(null);
            const [stats, setStats] = useState({});
            const [items, setItems] = useState([]);
            const [hats, setHats] = useState([]);
            const [showOnboarding, setShowOnboarding] = useState(false);
            const [loading, setLoading] = useState(true);
            const { connected, lastMessage } = useWebSocket();

            // Check onboarding status and load initial data
            useEffect(() => {
                Promise.all([
                    api('/setup/status').catch(() => ({ onboarding_completed: true })),
                    api('/identity').catch(() => ({})),
                    api('/stats').catch(() => ({})),
                    api('/hats').catch(() => []),
                    api('/items').catch(() => [])
                ]).then(([setup, id, st, h, i]) => {
                    // Show onboarding if not completed
                    if (!setup.completed_at && !setup.identity_created) {
                        setShowOnboarding(true);
                    }
                    setIdentity(id);
                    setStats(st);
                    setHats(Array.isArray(h) ? h : []);
                    setItems(Array.isArray(i) ? i : []);
                    setLoading(false);
                });
            }, []);

            // Handle WebSocket messages
            useEffect(() => {
                if (lastMessage) {
                    if (lastMessage.type === 'item.created' || lastMessage.type === 'item.updated') {
                        api('/items').then(i => setItems(Array.isArray(i) ? i : [])).catch(() => {});
                        api('/stats').then(st => setStats(st)).catch(() => {});
                    }
                    // Handle notification updates from WebSocket
                    if (lastMessage.type === 'notification') {
                        // The NotificationsBell component will handle refresh via its own polling
                    }
                }
            }, [lastMessage]);

            const handleOnboardingComplete = () => {
                setShowOnboarding(false);
                // Reload data after onboarding
                Promise.all([
                    api('/identity').catch(() => ({})),
                    api('/hats').catch(() => [])
                ]).then(([id, h]) => {
                    setIdentity(id);
                    setHats(Array.isArray(h) ? h : []);
                });
            };

            const renderView = () => {
                switch (currentView) {
                    case 'dashboard': return <Dashboard stats={stats} items={items} hats={hats} />;
                    case 'inbox': return <Inbox items={items} hats={hats} />;
                    case 'hats': return <HatsView hats={hats} />;
                    case 'recommendations': return <Recommendations />;
                    case 'learning': return <LearningView />;
                    case 'chat': return <ChatView />;
                    case 'spaces': return <SpacesView />;
                    case 'settings': return <Settings />;
                    default: return <Dashboard stats={stats} items={items} hats={hats} />;
                }
            };

            if (loading) {
                return (
                    <div className="flex h-screen items-center justify-center bg-gray-50">
                        <div className="text-center">
                            <div className="text-4xl mb-4 animate-pulse">üß†</div>
                            <div className="text-gray-500">Loading QuantumLife...</div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="flex h-screen">
                    {showOnboarding && <OnboardingWizard onComplete={handleOnboardingComplete} />}
                    <Sidebar
                        currentView={currentView}
                        setCurrentView={setCurrentView}
                        identity={identity}
                        wsConnected={connected}
                    />
                    <div className="flex-1 flex flex-col overflow-hidden">
                        {/* Top Bar with Notifications */}
                        <header className="bg-white border-b border-gray-200 px-6 py-3 flex items-center justify-between shrink-0">
                            <div className="flex items-center">
                                <span className="text-gray-400 text-sm">
                                    {new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}
                                </span>
                            </div>
                            <div className="flex items-center space-x-4">
                                <NotificationsBell />
                                <div className="flex items-center">
                                    <div className="w-8 h-8 rounded-full gradient-bg flex items-center justify-center text-white text-sm font-medium">
                                        {identity?.name?.[0] || '?'}
                                    </div>
                                </div>
                            </div>
                        </header>
                        <main className="flex-1 overflow-auto bg-gray-50">
                            {renderView()}
                        </main>
                    </div>
                </div>
            );
        }

        // Render
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
